// Module included in the following assemblies:
//
// * nodes/nodes-nodes-rebooting.adoc

[id="nodes-nodes-rebooting-gracefully_{context}"]
= Rebooting a node gracefully

Before rebooting a node, it is recommended to backup etcd data to avoid any data loss on the node.

.Procedure

To perform a graceful restart of a node:

. Mark the node as unschedulable:
+
[source,terminal]
----
$ oc adm cordon <node1>
----

. Drain the node to remove all the running pods:
+
[source,terminal]
----
$ oc adm drain <node1> --ignore-daemonsets --delete-emptydir-data --grace-period=300 --force
----

. (Optional) PodDisruptionBudget exists:

+ 
If there is any PodDisruptionBudget defined on the cluster, some extra steps have to be performed before draining the node, otherwise the draining will fail.

+
Either scale the deployment which has the PodDisruptionBudget defined to 0:
+
[source,terminal]
----
$ oc scale deployment <deploy> -n <namespace> --replicas=0
----

+
or delete the PodDisruptionBudget temporarily:

+
[source,terminal]
----
$ oc delete -f pdb.yaml 
----

. Access the node in debug mode:
+
[source,terminal]
----
$ oc debug node/<node1>
----


. Change your root directory to the host:
+
[source,terminal]
----
$ chroot /host
----

. Restart the node:
+
[source,terminal]
----
$ systemctl reboot
----
+

. (Optional) OC command not available:
+
OC command may be not available due to different reasons, SSH can be used to connect to the target server as an alternative option.
+
[source,terminal]
----
$ ssh core@<target_node>
$ sudo systemctl reboot
----

+
In a moment, the node enters the `NotReady` state.

. After node rebooted:

+ 
Mark the node as schedulable:

+
[source,terminal]
----
$ oc adm uncordon <node1>
----

. (Optional) SNO user with 'oc login'

+
For the SNO users who use the 'oc login' rather than the certificates in kubeconfig file to manage the cluster, before the node being uncordoned, 'oc adm' command won't be available due to the fact that openshift-oauth-apiserver pod is not running since the node is cordoned. Need to SSH to the target server to uncordon the node:

+
[source,terminal]
----
$ ssh core@<target_node>
$ sudo oc adm uncordon <node> --kubeconfig /etc/kubernetes/static-pod-resources/kube-apiserver-certs/secrets/node-kubeconfigs/localhost.kubeconfig
----

. Verify that the node is ready:
+
[source,terminal]
----
$ oc get node <node1>
----
+
.Example output
[source,terminal]
----
NAME    STATUS  ROLES    AGE     VERSION
<node1> Ready   worker   6d22h   v1.18.3+b0068a8
----

. (Optional) PodDisruptionBudget exists:

+ 
If any deployment has been ever scaled down or any PodDisruptionBudget has been ever deleted in previous steps, revert the change back:

+
[source,terminal]
----
$ oc scale deployment <deploy> -n <namespace> --replicas=<desired_replicas>
----

+
or enable the PodDisruptionBudget:

+
[source,terminal]
----
$ oc apply -f pdb.yaml 
----
